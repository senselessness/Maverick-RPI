<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Maverick Controls </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    
<link rel="stylesheet" href="/static/style.css" />

</head>
<body>

<div style ="text-align: center;">
    <h1>
    {{system.SystemName}}<br>Distribution System
    </h1>
    <form id="control" action ="", method = "post">
        <p><input type="hidden" name="Form" value="process"/></p>
        <p><input type ="submit" id="start" name="Process" value="Start"></p>
        <p><input type ="submit" id="stop" name="Process" value="Stop"></p>
    </form>
    <h2> Status Infromation </h2>
    <p class="med-font"> Product Completed:</p> 
    <p class="large-font" id="total">{{ system.Total_Product }}</p>
    <h3> Settings </h3>
    <p class="med-font"> Current Flow Meter Count:</p>
    <p class="large-font" id="counter">{{ system.Counter }}</p>
    <p class="small-font">Updated periodically or with page refresh</p>
    <p class="med-font"> Current Flow Meter Target Setting:</p>
    <p class="large-font">{{ system.Target }}</p>
    <form action ="", method = "post">
        <p><input type="hidden" name="Form" value="settings"/></p>
        <p><input type="number" name="targetsetting"/></p>
        <p><input type="submit" name="Submit"/></p>
    </form>
    <h4> Go Back </h4>
    <a href="/">
    <button>Main Page</button>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script>

    if (window.history.replaceState){
        window.history.replaceState(null, null, window.location.href);
        }
        
</script>

<script type='text/javascript'>

//Handles Web Control
    $('#start').click(function(){
        $(this).addClass("start");
        localStorage.Classname="start";
        })
        
    $('#stop').click(function(){
        $(this).removeClass("start");
        })

    $(document).ready(function(){
        setclass();
        });
    
    
    function setclass(){
        if("{{system.StartProcess}}"=="True"){
            $('#start').addClass(localStorage.Classname);
            }
        }

//Retrieves Data From other URL to update without page refresh
//Page only refreshes on submit buttons

    function pollData(){
        const totalp = document.getElementById("total");
        const counterp = document.getElementById("counter");
        
        if("{{system.SystemNumber}}"=="0"){
            fetch('/acvdata')
                .then(response => response.json())
                .then(data => {
                    totalp.innerHTML =data.total;
                    counterp.innerHTML=data.count;
                    //Handles Physical Button Presses
                    if(data.started==false && $('#start').hasClass("start")){
                        $('#start').removeClass("start");
                        }
                    else if (data.started==true && !$('#start').hasClass("start")){
                        $('#start').addClass("start");
                        }
                    })
                .catch(error => console.error("Error Fetching Data for ACV"));
            }
        else if("{{system.SystemNumber}}"=="1"){
            fetch('/oildata')
                .then(response => response.json())
                .then(data => {
                    totalp.innerHTML =data.total;
                    counterp.innerHTML=data.count;
                    if(data.started==false && $('#start').hasClass("start")){
                        $('#start').removeClass("start")
                        }
                    })
                .catch(error => console.error("Error Fetching Data for Oil"));
            }
        }
    
    //Polls data
    //Cannot use websockets with python 2.7
    
    setInterval(pollData, 200);
    pollData();
    
    
</script>

</html>